os: linux
language: generic

branches:
  only:
    - master
    - develop

script:
  - |
    ENV_OPT="-e GH_TOKEN=$GH_TOKEN"
    ENV_OPT="$ENV_OPT -e HBS_BUILD_NUMBER="
    PUBLISH_OPT="-p onTagOrDraft"
    if [ "$TRAVIS_BRANCH" = "develop" ]; then
      ENV_OPT="-e BT_TOKEN=$BT_TOKEN"
      ENV_OPT="$ENV_OPT -e TRAVIS_REPO_SLUG=francoiscolas/hibiscusapp"
      ENV_OPT="$ENV_OPT -e HBS_BUILD_NUMBER=-b$TRAVIS_BUILD_NUMBER"
      PUBLISH_OPT="-p always"
    fi

    docker run --rm $ENV_OPT \
      -v ${PWD}:/project \
      -v ~/.cache/electron:/root/.cache/electron \
      -v ~/.cache/electron-builder:/root/.cache/electron-builder \
      electronuserland/builder:wine \
      /bin/bash -c "yarn --link-duplicates --pure-lockfile \
                    && yarn dist -wl $PUBLISH_OPT"

before_cache:
  - rm -rf $HOME/.cache/electron-builder/wine

cache:
  directories:
    - node_modules
    - $HOME/.cache/electron
    - $HOME/.cache/electron-builder
